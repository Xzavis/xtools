<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Hub - Xtools</title>
    <!-- Bootstrap 5 & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
        /* Modern Neubrutalist Tweaks */
        .nav-tabs {
            border-bottom: 2px solid var(--color-border);
        }
        .nav-link {
            color: #666;
            font-weight: 800;
            border: none;
            border-radius: 0;
            padding: 15px 25px;
            text-transform: uppercase;
        }
        .nav-link.active {
            color: var(--color-primary);
            background: transparent;
            border-bottom: 4px solid var(--color-primary);
        }
        .nav-link:hover {
            color: var(--color-primary);
        }

        .search-card {
            background: var(--color-bg-surface);
            border: 2px solid var(--color-border);
            transition: transform 0.1s;
            cursor: pointer;
        }
        .search-card:hover {
            border-color: var(--color-primary);
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0px 0px var(--color-primary);
        }
        
        .stat-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 6px;
            background: #000;
            border: 1px solid #333;
            color: #ccc;
        }

        /* Queue Panel */
        .queue-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background: #000;
            border: 2px solid var(--color-primary);
            box-shadow: 8px 8px 0px 0px rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        .queue-header {
            background: var(--color-primary);
            color: #000;
            padding: 10px;
            font-weight: 900;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .queue-body {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        .queue-item {
            font-size: 0.75rem;
            margin-bottom: 8px;
            border-bottom: 1px solid #333;
            padding-bottom: 4px;
        }
        .terminal-logs {
            font-family: 'Fira Code', monospace;
            font-size: 0.75rem;
            height: 200px;
            overflow-y: auto;
            background: #050505;
            padding: 10px;
            border: 1px solid #333;
            color: #0f0;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    {% set active_page = 'hf_downloader' %}
    {% include 'sidebar.html' %}

    <div class="main-content">
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-end mb-4">
            <div>
                <h1 class="display-4 fw-900 m-0">MODEL HUB <span class="text-primary">V2</span></h1>
                <p class="text-muted fw-bold">ADVANCED REPOSITORY MANAGEMENT & PARALLEL TRANSFER</p>
            </div>
            <div class="d-flex gap-3">
                 <div class="input-group">
                    <span class="input-group-text bg-black border-secondary text-muted">HF_TOKEN</span>
                    <input type="password" id="hfToken" class="form-control bg-dark text-white border-secondary" style="width: 150px;" placeholder="Optional">
                 </div>
            </div>
        </div>

        <!-- Navigation -->
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane" type="button"><i class="fa-solid fa-search me-2"></i> GLOBAL SEARCH</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="repo-tab" data-bs-toggle="tab" data-bs-target="#repo-pane" type="button"><i class="fa-solid fa-database me-2"></i> REPO INSPECTOR</button>
            </li>
        </ul>

        <div class="tab-content">
            
            <!-- SEARCH PANE -->
            <div class="tab-pane fade show active" id="search-pane">
                <div class="app-card mb-4">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <select id="searchType" class="form-select fw-bold">
                                <option value="model">MODELS</option>
                                <option value="dataset">DATASETS</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <input type="text" id="searchQuery" class="form-control fw-bold" placeholder="Enter keywords (e.g. 'llama-3', 'finance-sentiment')..." onkeydown="if(event.key==='Enter') runSearch()">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100 fw-bold" onclick="runSearch()">SEARCH</button>
                        </div>
                    </div>
                </div>

                <div id="searchResults" class="row g-3">
                    <!-- Results populated here -->
                    <div class="col-12 text-center py-5 text-muted">
                        <i class="fa-solid fa-magnifying-glass fs-1 mb-3"></i>
                        <h5>ENTER QUERY TO BEGIN</h5>
                    </div>
                </div>
            </div>

            <!-- REPO PANE -->
            <div class="tab-pane fade" id="repo-pane">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <!-- Controls -->
                        <div class="app-card mb-3">
                            <div class="input-group">
                                <span class="input-group-text fw-bold">REPO_ID</span>
                                <input type="text" id="directRepoId" class="form-control font-monospace" placeholder="org/repo_name">
                                <button class="btn btn-primary fw-bold px-4" onclick="loadRepoFromInput()">LOAD</button>
                            </div>
                        </div>

                        <!-- File Browser -->
                        <div id="fileBrowser" class="d-none">
                            <div class="app-card">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="m-0 fw-bold text-primary"><i class="fa-regular fa-folder-open me-2"></i>CONTENTS</h5>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="selectAll(true)">ALL</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="selectAll(false)">NONE</button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="selectPattern('jsonl')">JSONL</button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="selectPattern('safetensors')">TENSORS</button>
                                    </div>
                                </div>
                                
                                <input type="text" id="fileFilter" class="form-control form-control-sm mb-3 bg-dark border-secondary text-white" placeholder="Filter files..." oninput="renderFileList()">
                                
                                <div style="height: 400px; overflow-y: auto; border: 1px solid #333;">
                                    <table class="table table-dark table-hover table-sm mb-0 font-monospace" style="font-size: 0.8rem;">
                                        <thead>
                                            <tr>
                                                <th width="40" class="text-center">#</th>
                                                <th>FILENAME</th>
                                                <th class="text-end">SIZE</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fileTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                         
                        <!-- Placeholder -->
                        <div id="repoPlaceholder" class="text-center py-5">
                            <h4 class="text-muted fw-bold">NO REPOSITORY LOADED</h4>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <!-- Repo Stats -->
                        <div class="app-card mb-3 d-none" id="repoStatsCard">
                            <h6 class="fw-bold text-primary mb-3">METADATA</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span>FILES</span>
                                <span class="fw-bold" id="statFileCount">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>SIZE</span>
                                <span class="fw-bold" id="statTotalSize">0 B</span>
                            </div>
                        </div>

                        <!-- Download Options -->
                        <div class="app-card mb-3 d-none" id="downloadOptionsCard">
                            <h6 class="fw-bold text-primary mb-3">DOWNLOAD</h6>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="useLocal" checked onchange="toggleLocalPath()">
                                <label class="form-check-label fw-bold">SAVE TO DISK</label>
                            </div>

                            <div id="localPathGroup" class="mb-3">
                                <div class="input-group input-group-sm">
                                    <input type="text" id="localPath" class="form-control" value="C:\\Downloads\\Models">
                                    <button class="btn btn-outline-secondary" onclick="openPathModal()">...</button>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button class="btn btn-primary fw-bold" onclick="startDownload()">
                                    <i class="fa-solid fa-download me-2"></i> START TRANSFER (<span id="selectedCount">0</span>)
                                </button>
                            </div>
                        </div>
                        
                        <!-- Mini Log -->
                        <div class="app-card p-2">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="fw-bold">ACTIVITY LOG</small>
                                <small class="text-muted cursor-pointer" onclick="clearLog()">CLEAR</small>
                            </div>
                            <div id="miniLog" class="terminal-logs"></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Path Browser Modal (Reused) -->
    <div class="modal fade" id="pathBrowserModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">BROWSE</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex gap-2 mb-2">
                        <button class="btn btn-sm btn-primary" onclick="browsePath('::DRIVES::')">Drives</button>
                        <input type="text" id="modalCurrentPath" class="form-control form-control-sm" readonly>
                    </div>
                    <div id="modalPathList" class="list-group list-group-flush border" style="height: 300px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="selectPath()">Select This Folder</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State
        let currentRepoFiles = [];
        let selectedFiles = new Set();
        let pathModal;

        document.addEventListener('DOMContentLoaded', () => {
             pathModal = new bootstrap.Modal(document.getElementById('pathBrowserModal'));
             const token = localStorage.getItem('hf_token');
             if(token) document.getElementById('hfToken').value = token;
             
             // Check if we passed a repo via search
             const repo = localStorage.getItem('nav_repo');
             if(repo) {
                 localStorage.removeItem('nav_repo');
                 document.getElementById('directRepoId').value = repo;
                 const tab = new bootstrap.Tab(document.getElementById('repo-tab'));
                 tab.show();
                 loadRepoFromInput();
             }
        });

        // --- SEARCH ---
        async function runSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const type = document.getElementById('searchType').value;
            const resContainer = document.getElementById('searchResults');
            
            if(!query) return;
            
            resContainer.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>';
            
            try {
                const res = await fetch('/api/hf_search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ query, repo_type: type, limit: 12 })
                });
                const data = await res.json();
                
                resContainer.innerHTML = '';
                if(data.data.length === 0) {
                    resContainer.innerHTML = '<div class="col-12 text-center py-5">NO RESULTS FOUND</div>';
                    return;
                }

                data.data.forEach(item => {
                    const card = `
                        <div class="col-md-6 col-xl-4">
                            <div class="search-card p-3 h-100 d-flex flex-column" onclick="goToRepo('${item.id}')">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="fw-bold text-primary text-break mb-0">${item.id}</h6>
                                    <span class="badge bg-secondary">${type.toUpperCase()}</span>
                                </div>
                                <div class="mb-3 text-muted small">
                                    By ${item.author || 'Unknown'}
                                </div>
                                <div class="mt-auto d-flex gap-2">
                                    <span class="stat-badge"><i class="fa-solid fa-download me-1"></i>${formatNum(item.downloads)}</span>
                                    <span class="stat-badge"><i class="fa-solid fa-heart me-1"></i>${formatNum(item.likes)}</span>
                                    <span class="stat-badge"><i class="fa-solid fa-clock me-1"></i>${item.lastModified ? item.lastModified.split('T')[0] : 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    resContainer.innerHTML += card;
                });

            } catch(e) {
                resContainer.innerHTML = `<div class="col-12 text-center text-danger">ERROR: ${e.message}</div>`;
            }
        }

        function goToRepo(id) {
            document.getElementById('directRepoId').value = id;
            const tab = new bootstrap.Tab(document.getElementById('repo-tab'));
            tab.show();
            loadRepoFromInput();
        }

        // --- REPO MANAGE ---
        async function loadRepoFromInput() {
            const id = document.getElementById('directRepoId').value.trim();
            const token = document.getElementById('hfToken').value.trim();
            if(token) localStorage.setItem('hf_token', token);
            
            if(!id) return;
            
            log(`Scanning ${id}...`);
            document.getElementById('repoPlaceholder').classList.add('d-none');
            document.getElementById('fileBrowser').classList.add('d-none');
            
            try {
                // Determine type roughly or assume model if not set in search
                const type = document.getElementById('searchType').value; 

                const res = await fetch('/api/hf_scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ repo_id: id, repo_type: type, token })
                });
                const data = await res.json();
                
                if(!data.success) throw new Error(data.error);
                
                currentRepoFiles = data.files;
                selectedFiles.clear();
                renderFileList();
                
                // Stats
                document.getElementById('statFileCount').innerText = data.total_files;
                const totalSize = data.files.reduce((a,b) => a + b.size, 0);
                document.getElementById('statTotalSize').innerText = formatBytes(totalSize);
                
                document.getElementById('repoStatsCard').classList.remove('d-none');
                document.getElementById('downloadOptionsCard').classList.remove('d-none');
                document.getElementById('fileBrowser').classList.remove('d-none');
                log(`Loaded ${data.total_files} files.`);

            } catch(e) {
                log(`Error: ${e.message}`);
                document.getElementById('repoPlaceholder').classList.remove('d-none');
                document.getElementById('repoPlaceholder').innerHTML = `<h5 class="text-danger">${e.message}</h5>`;
            }
        }

        function renderFileList() {
            const filter = document.getElementById('fileFilter').value.toLowerCase();
            const tbody = document.getElementById('fileTableBody');
            tbody.innerHTML = '';
            
            const visible = currentRepoFiles.filter(f => f.path.toLowerCase().includes(filter));
            
            // Limit render to 500 for perf
            visible.slice(0, 500).forEach(f => {
                const tr = document.createElement('tr');
                const checked = selectedFiles.has(f.path) ? 'checked' : '';
                tr.innerHTML = `
                    <td class="text-center"><input type="checkbox" class="form-check-input" ${checked} onchange="toggleFile('${f.path}')"></td>
                    <td class="text-break">${f.path}</td>
                    <td class="text-end text-muted">${formatBytes(f.size)}</td>
                `;
                tbody.appendChild(tr);
            });
            updateCount();
        }

        function toggleFile(path) {
            if(selectedFiles.has(path)) selectedFiles.delete(path);
            else selectedFiles.add(path);
            updateCount();
        }

        function updateCount() {
            document.getElementById('selectedCount').innerText = selectedFiles.size;
        }

        function selectAll(state) {
            const filter = document.getElementById('fileFilter').value.toLowerCase();
            currentRepoFiles.filter(f => f.path.toLowerCase().includes(filter)).forEach(f => {
                if(state) selectedFiles.add(f.path);
                else selectedFiles.delete(f.path);
            });
            renderFileList();
        }

        function selectPattern(pat) {
            currentRepoFiles.forEach(f => {
                if(f.path.toLowerCase().includes(pat)) selectedFiles.add(f.path);
            });
            renderFileList();
        }

        // --- DOWNLOAD ---
        async function startDownload() {
            const files = Array.from(selectedFiles);
            if(files.length === 0) { log("No files selected"); return; }
            
            const id = document.getElementById('directRepoId').value;
            const type = document.getElementById('searchType').value;
            const token = document.getElementById('hfToken').value;
            const local = document.getElementById('useLocal').checked;
            const path = document.getElementById('localPath').value;

            if(local && !path) { log("Please set a local path"); return; }

            if(!local) {
                // Browser download links
                const res = await fetch('/api/hf_download_links', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ repo_id: id, repo_type: type, files: files })
                });
                const d = await res.json();
                d.links.forEach(l => window.open(l, '_blank'));
                log("Browser download links generated.");
                return;
            }

            // Server Download
            log("Starting concurrent download...");
            const res = await fetch('/api/hf_download_server', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    repo_id: id, 
                    repo_type: type, 
                    files: files, 
                    local_dir: path, 
                    token: token 
                })
            });

            const reader = res.body.getReader();
            const dec = new TextDecoder();
            
            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                const chunk = dec.decode(value);
                const lines = chunk.split('\n');
                lines.forEach(line => {
                    if(!line.trim()) return;
                    try {
                        const msg = JSON.parse(line);
                        if(msg.type === 'progress') {
                            // Can be too spammy for main log, maybe a status bar?
                            // For now just log sparingly or update a specific element
                        } else if(msg.type === 'success' || msg.type === 'error' || msg.type === 'done') {
                            log(msg.message);
                        }
                    } catch(e) {}
                });
            }
        }

        // --- UTILS ---
        function log(msg) {
            const el = document.getElementById('miniLog');
            const div = document.createElement('div');
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            el.appendChild(div);
            el.scrollTop = el.scrollHeight;
        }
        function clearLog() { document.getElementById('miniLog').innerHTML = ''; }
        function formatBytes(b) {
            if(b===0) return '0 B';
            const u = ['B','KB','MB','GB','TB'];
            const i = Math.floor(Math.log(b)/Math.log(1024));
            return parseFloat((b/Math.pow(1024,i)).toFixed(2)) + ' ' + u[i];
        }
        function formatNum(n) {
            if(n > 1000000) return (n/1000000).toFixed(1) + 'M';
            if(n > 1000) return (n/1000).toFixed(1) + 'K';
            return n;
        }
        function toggleLocalPath() {
             const chk = document.getElementById('useLocal').checked;
             document.getElementById('localPathGroup').classList.toggle('d-none', !chk);
        }

        // Path Browser
        function openPathModal() { pathModal.show(); browsePath('::DRIVES::'); }
        async function browsePath(p) {
            const list = document.getElementById('modalPathList');
            list.innerHTML = 'Loading...';
            const res = await fetch('/browse', {method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({path:p})});
            const data = await res.json();
            document.getElementById('modalCurrentPath').value = data.current_path;
            list.innerHTML = '';
            
            if(data.parent_path) {
                list.innerHTML += `<button class="list-group-item list-group-item-action" onclick="browsePath('${data.parent_path.replace(/\\/g, '\\\\')}')">.. (Up)</button>`;
            }
            data.dirs.forEach(d => {
                const full = (data.current_path === 'My PC' ? d : data.current_path + (data.current_path.endsWith('\\')?'':'\\') + d).replace(/\\/g, '\\\\');
                list.innerHTML += `<button class="list-group-item list-group-item-action" onclick="browsePath('${full}')"><i class="fa fa-folder text-warning me-2"></i>${d}</button>`;
            });
        }
        function selectPath() {
            document.getElementById('localPath').value = document.getElementById('modalCurrentPath').value;
            pathModal.hide();
        }

    </script>
</body>
</html>